<template>
  <div class="list" v-for="(invoice, index) of invoices" :key="index">
    <Listitems v-show="isShow" v-model:close="isShow" />
    <button type="button" @click="toggleInputForm"></button>
    <div class="list_data">
      <div class="date">
        {{
          `${new Date(invoice.time).getMonth() + 1}/${new Date(
            invoice.time
          ).getDate()}`
        }}
      </div>

      <!-- 如果type是0，就是顯示載具 -->
      <!-- 如果type是1，會有兩種顯示: 驗證中、電子 -->
      <div :class="invoice.status === '驗證中' ? 'tags-verify' : 'tags'">
        <h4 v-if="invoice.type === 0">
          {{ "載具" }}
        </h4>
        <h4 v-if="invoice.type === 1 && invoice.status != '驗證中'">
          {{ "電子" }}
        </h4>
        <h4 v-if="invoice.type === 1 && invoice.status === '驗證中'">
          {{ "驗證中" }}
        </h4>
      </div>
    </div>
    <div class="list_data item_bargainor">
      {{ invoices.item }}

      <div
        class="item_name"
        v-for="(details, index) of invoice.details"
        :key="index"
      >
        <h2 v-if="index === 0">{{ details.description }}</h2>
      </div>
      <div class="bargainor">
        <h4>{{ invoice.sellerName }}</h4>
      </div>
    </div>
    <div class="list_data price">
      <div v-if="invoice.status != '驗證中'" v-show="invoice.amount">
        {{ invoice.amount }}元
      </div>
      <div v-else-if="(invoice.status = '驗證中')">{{ "--" }}元</div>
    </div>
  </div>
</template>
<script>
import axios from "axios";
import Listitems from "@/components/ListComponent/Listitems.vue";
export default {
  name: "List",
  components: { Listitems },
  emits: {
    // No validation
    click: null,
    // Validate submit event
    updateTotalUnits: (length) => {
      return length;
    },
    updateTotalAmount: (sum) => {
      return sum;
    },
  },
  data() {
    return {
      isShow: false,
      invoices: [],
    };
  },
  mounted() {
    this.getinvoicesList();
  },
  methods: {
    toggleInputForm() {
      this.isShow = !this.isShow;
    },
    async getinvoicesList() {
      await axios
        .get(`http://localhost:3000/invoices`)
        .then((res) => {
          const invoices = res.data;
          this.invoices = invoices;
          this.updateTotalUnits();
          this.updateTotalAmount();
          this.invoices = this.sortByDate(this.invoices, "time");
        })
        .catch((err) => {
          console.log(err);
        });
    },
    sortByDate(arr, key) {
      const sortedArr = arr.sort(function (a, b) {
        return new Date(a[key]) - new Date(b[key]);
      });
      return sortedArr;
    },
    updateTotalUnits() {
      const length = this.invoices.length;
      this.$emit("updateTotalUnits", length);
    },
    updateTotalAmount() {
      const invoices = this.invoices;
      let sum = 0;
      invoices.map((item) => {
        if (item.amount) {
          sum = sum + item.amount;
        }
      });
      this.$emit("updateTotalAmount", sum);
    },
  },
};
</script>
